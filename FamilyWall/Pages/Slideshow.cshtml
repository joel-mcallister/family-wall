@* 
PSEUDOCODE / PLAN (detailed):
1. Structure
   - Create a fixed full-viewport `#backgroundLayer` that displays the background image at 50% opacity.
   - Place a centered foreground image `#randomImage` above the background.
   - Add a full-viewport `#blackOverlay` above everything; used to fade to black and back.

2. Styling
   - `#backgroundLayer` is fixed, covers viewport, background-size: cover; set `opacity: 0.5`.
   - `#randomImage` is centered, constrained to viewport, transitions only opacity.
   - `#blackOverlay` is fixed, black background, opacity transitions from 0 -> 1 -> 0 for the fade-to-black effect.
   - Remove all other animations (no transforms/zoom).

3. JavaScript flow
   - Request random image URL from handler with cache: 'no-store'.
   - Preload the new image using an Image() object.
   - When preloaded:
       a. Start transition: add overlay class to make overlay opacity 1 and add `fading` class to foreground image (opacity 0).
       b. On overlay transitionend (i.e. after fade to black completes), update the `#backgroundLayer` background-image and the foreground `src`.
       c. Remove overlay class and `fading` class to fade back in.
   - Keep interval refresh and click-to-refresh.
   - Ensure safe URL quoting when applying as CSS background or src.

4. Accessibility
   - Foreground `img` has `alt` text.
   - Minimal markup compatible with Razor Pages.
*@

@page
@using System.Text.Json
@model SlideshowModel
@{
    ViewData["Title"] = "Photo Slideshow";
}
    
<div id="randomImageBody">
    <div id="backgroundLayer" aria-hidden="true"></div>

    <div id="foregroundLayer" role="img" aria-label="Slideshow image container">
        <img id="randomImage" class="rounded" alt="Slideshow image" />
    </div>

    <div id="blackOverlay" aria-hidden="true"></div>
</div>

@section Head
{
    <style>
        /* Full-viewport background layer at 50% opacity (does not affect children) */
        #backgroundLayer {
            position: fixed;
            inset: 0;
            z-index: 0;
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
            opacity: 0.15; 
            pointer-events: none;
        }

        /* Foreground container centers the image */
        #foregroundLayer {
            position: fixed;
            inset: 0;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        /* Foreground image: only opacity transitions */
        #randomImage {
            display: block;
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
            transition: opacity 0.45s ease-in-out;
            opacity: 1;
            border-radius: 0.5rem;
            pointer-events: auto; /* allow clicks to trigger refresh on body */
            cursor: pointer;
        }

        /* When fading out to black, foreground image becomes transparent */
        #randomImage.fading {
            opacity: 0;
        }

        /* Full-viewport black overlay used to fade to black and back */
        #blackOverlay {
            position: fixed;
            inset: 0;
            z-index: 2;
            background: #000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.45s ease-in-out;
        }

        /* Visible state for overlay (fully black) */
        #blackOverlay.visible {
            opacity: 1;
        }

        /* Ensure body/background behind container is black */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
        }

        /* Ensure clickable area spans entire page */
        #randomImageBody {
            position: relative;
            min-height: 100vh;
            width: 100%;
        }
    </style>
}
@section Scripts {
    <script>
        function safeCssUrl(url) {
            return "url('" + url.replace(/'/g, "\\'") + "')";
        }

        function applyBackground(url) {
            $('#backgroundLayer').css('background-image', safeCssUrl(url));
        }

        function swapWithFade(url) {
            var $overlay = $('#blackOverlay');
            var $img = $('#randomImage');

            // Preload handled by caller; this function handles the transition and swap.
            // Start fade to black and fade out image.
            $overlay.addClass('visible');
            $img.addClass('fading');

            // Wait for overlay transition to finish (fade to black complete), then swap.
            $overlay.one('transitionend', function (e) {
                // Ensure the transitionend was for opacity (some browsers emit multiple)
                if (e.originalEvent && e.originalEvent.propertyName && e.originalEvent.propertyName !== 'opacity') {
                    return;
                }

                // Update background and foreground src
                applyBackground(url);
                $img.attr('src', url);

                // Small delay to ensure DOM updated then fade back in
                setTimeout(function () {
                    $overlay.removeClass('visible');
                    $img.removeClass('fading');
                }, 40);
            });
        }

        function loadRandomImage() {
            fetch('./?handler=RandomImage', { cache: 'no-store' })
                .then(function (response) {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(function (data) {
                    if (!data || !data.url) throw new Error('Invalid image data');

                    var url = data.url;

                    // Preload the image first, then perform the fade-swap so black covers smoothly.
                    var temp = new Image();
                    temp.onload = function () {
                        swapWithFade(url);
                    };
                    temp.onerror = function () {
                        console.error('Failed to preload image:', url);
                        // Still attempt the swap to surface the failure (browser may show broken image)
                        swapWithFade(url);
                    };
                    temp.src = url;
                })
                .catch(function (err) {
                    console.error('Failed to load image:', err);
                });
        }

        $(function () {
            // Initial load: fetch and set background & foreground without visible flicker.
            fetch('./?handler=RandomImage', { cache: 'no-store' })
                .then(function (r) { if (!r.ok) throw new Error('Network'); return r.json(); })
                .then(function (d) {
                    if (d && d.url) {
                        // Preload then set immediately without overlay animation on first load
                        var temp = new Image();
                        temp.onload = function () {
                            applyBackground(d.url);
                            $('#randomImage').attr('src', d.url);
                        };
                        temp.onerror = function () {
                            applyBackground(d.url);
                            $('#randomImage').attr('src', d.url);
                        };
                        temp.src = d.url;
                    }
                })
                .catch(function (e) { console.error(e); })
                .finally(function () {
                    // Regular refresh cycle and click-to-refresh
                    setInterval(loadRandomImage, 60 * 1000);
                    $('#randomImageBody').on('click', function () {
                        loadRandomImage();
                    });
                    // Also allow clicking the image itself
                    $('#randomImage').on('click', function (ev) {
                        ev.stopPropagation();
                        loadRandomImage();
                    });
                });
        });
    </script>
    <script src="~/js/slideshow.js"></script>
}